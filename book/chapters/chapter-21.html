<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chapter 21: Logic Synthesis | Create Your Own GPU</title>
    <link rel="stylesheet" href="../styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        .chapter-content { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
        .code-block { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-x: auto; margin: 20px 0; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.5; }
        .code-block code { color: #d4d4d4; }
        .keyword { color: #569cd6; }
        .type { color: #4ec9b0; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; }
        .number { color: #b5cea8; }
        .key-takeaway { background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%); border-left: 4px solid #2196f3; padding: 20px; margin: 24px 0; border-radius: 0 8px 8px 0; }
        .exercise { background: linear-gradient(135deg, #fff3e0 0%, #fffaf0 100%); border-left: 4px solid #ff9800; padding: 20px; margin: 24px 0; border-radius: 0 8px 8px 0; }
        .mermaid { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin: 20px 0; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #e0e0e0; padding: 14px 16px; text-align: left; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #f0f4ff; }
        .info-box { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 16px; margin: 20px 0; }
        .warning-box { background: #fff8e1; border: 1px solid #ffc107; border-radius: 8px; padding: 16px; margin: 20px 0; }
        .nav-container { display: flex; justify-content: space-between; margin: 40px 0; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-container a { text-decoration: none; color: #667eea; font-weight: 500; transition: color 0.3s; }
        .nav-container a:hover { color: #764ba2; }
        h2 { color: #333; border-bottom: 3px solid #667eea; padding-bottom: 10px; margin-top: 40px; }
        h3 { color: #555; margin-top: 30px; }
        .solution { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 16px; margin-top: 16px; border-radius: 0 8px 8px 0; }
        .file-header { background: #2d2d2d; color: #9cdcfe; padding: 8px 16px; border-radius: 8px 8px 0 0; font-size: 12px; font-family: monospace; margin-bottom: -20px; }
    </style>
</head>
<body>
    <div class="chapter-content">
        <div class="nav-container">
            <a href="chapter-20.html">‚Üê Previous: Simulation and Debugging</a>
            <a href="../table-of-contents.html">Table of Contents</a>
            <a href="chapter-22.html">Next: Physical Design Flow ‚Üí</a>
        </div>

        <h1>Chapter 21: Logic Synthesis</h1>
        <div style="color: #666; margin: 20px 0; font-size: 0.95em;">
            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; margin-right: 10px;">Part V: Verification & Tools</span>
            <span>Reading time: ~55 minutes</span>
        </div>

        <h2>Introduction</h2>
        <p>Logic synthesis transforms RTL code into a gate-level netlist. This is where your SystemVerilog becomes actual logic gates that can be manufactured. This chapter covers synthesis concepts, tools, and optimization strategies.</p>

        <h2>21.1 What is Synthesis?</h2>

        <div class="mermaid">
graph LR
    RTL["RTL Code<br/>(SystemVerilog)"] --> SYNTH["Synthesis<br/>Tool"]
    TECH["Technology<br/>Library"] --> SYNTH
    SYNTH --> GATE["Gate-Level<br/>Netlist"]
    
    style RTL fill:#e3f2fd
    style SYNTH fill:#fff3e0
    style GATE fill:#e8f5e9
    style TECH fill:#f3e5f5
        </div>

        <p>Synthesis performs three main transformations:</p>
        <ol>
            <li><strong>RTL ‚Üí Logic:</strong> Converts behavioral code to Boolean equations</li>
            <li><strong>Logic ‚Üí Gates:</strong> Maps equations to standard cells</li>
            <li><strong>Gates ‚Üí Optimized:</strong> Minimizes area, power, and timing</li>
        </ol>

        <h2>21.2 The Synthesis Flow</h2>

        <div class="mermaid">
graph TB
    subgraph "Frontend"
        PARSE["Parse RTL"]
        ELAB["Elaborate"]
        HIER["Flatten Hierarchy"]
    end
    
    subgraph "Optimization"
        GENERIC["Technology-Independent<br/>Optimization"]
        MAP["Technology Mapping"]
        OPT["Gate-Level<br/>Optimization"]
    end
    
    subgraph "Output"
        NET["Generate Netlist"]
        RPT["Generate Reports"]
    end
    
    PARSE --> ELAB --> HIER
    HIER --> GENERIC --> MAP --> OPT
    OPT --> NET --> RPT
    
    style GENERIC fill:#e3f2fd
    style MAP fill:#fff3e0
    style OPT fill:#e8f5e9
        </div>

        <h2>21.3 Yosys: Open-Source Synthesis</h2>

        <p>Yosys is the synthesis tool used by OpenLane for open-source ASIC flows:</p>

        <div class="code-block">
<code><span class="comment"># Basic Yosys synthesis script</span>

<span class="comment"># Read Verilog (after sv2v conversion)</span>
read_verilog build/gpu.v

<span class="comment"># Elaborate the design</span>
hierarchy -check -top gpu

<span class="comment"># High-level synthesis</span>
proc                 <span class="comment"># Convert processes to netlists</span>
flatten              <span class="comment"># Flatten hierarchy</span>
opt                  <span class="comment"># Basic optimization</span>

<span class="comment"># Technology mapping</span>
synth -top gpu       <span class="comment"># Generic synthesis</span>

<span class="comment"># Map to standard cells (e.g., Sky130)</span>
abc -liberty sky130_fd_sc_hd__tt_025C_1v80.lib

<span class="comment"># Clean up</span>
opt_clean

<span class="comment"># Write output</span>
write_verilog -noattr gpu_synth.v
stat                 <span class="comment"># Print statistics</span>
</code>
        </div>

        <h3>21.3.1 Synthesis Statistics</h3>

        <div class="code-block">
<code><span class="comment"># Example Yosys output:</span>
=== gpu ===

   Number of wires:              3247
   Number of wire bits:         12893
   Number of public wires:        521
   Number of public wire bits:   4521
   Number of memories:              0
   Number of memory bits:           0
   Number of processes:             0
   Number of cells:              8934
     sky130_fd_sc_hd__a21o_1       127
     sky130_fd_sc_hd__and2_1       234
     sky130_fd_sc_hd__dfxtp_1     1024
     sky130_fd_sc_hd__inv_1        567
     sky130_fd_sc_hd__mux2_1       412
     sky130_fd_sc_hd__nand2_1      823
     sky130_fd_sc_hd__nor2_1       456
     sky130_fd_sc_hd__o21a_1       234
     ...
</code>
        </div>

        <h2>21.4 Technology Libraries</h2>

        <h3>21.4.1 Standard Cell Library</h3>

        <p>Standard cells are pre-designed, pre-characterized logic gates:</p>

        <table>
            <thead>
                <tr><th>Cell Type</th><th>Example Cells</th><th>Purpose</th></tr>
            </thead>
            <tbody>
                <tr><td>Combinational</td><td>AND2, OR2, NAND3, XOR2, MUX2</td><td>Boolean logic</td></tr>
                <tr><td>Sequential</td><td>DFF, DFFR, DFFS, LATCH</td><td>State storage</td></tr>
                <tr><td>Buffer/Inverter</td><td>BUF, INV, CLKBUF</td><td>Signal drive</td></tr>
                <tr><td>Complex</td><td>AOI21, OAI22, AO22</td><td>Multi-level gates</td></tr>
            </tbody>
        </table>

        <h3>21.4.2 Drive Strengths</h3>

        <div class="info-box">
            <p>Cells come in different drive strengths (e.g., NAND2_1, NAND2_2, NAND2_4). Higher drive = faster output transitions but more area/power.</p>
        </div>

        <h3>21.4.3 Liberty Files (.lib)</h3>

        <div class="code-block">
<code><span class="comment">/* Liberty format cell definition */</span>
cell (sky130_fd_sc_hd__and2_1) {
    area : 5.0;
    
    pin (A) {
        direction : input;
        capacitance : 0.002;
    }
    pin (B) {
        direction : input;
        capacitance : 0.002;
    }
    pin (X) {
        direction : output;
        function : "(A & B)";
        timing () {
            related_pin : "A";
            cell_rise (delay_template) { ... }
            cell_fall (delay_template) { ... }
        }
    }
}
</code>
        </div>

        <h2>21.5 Optimization Strategies</h2>

        <h3>21.5.1 Area Optimization</h3>

        <div class="code-block">
<code><span class="comment"># Yosys area-focused optimization</span>
synth -top gpu
abc -liberty lib.lib -script +strash;drw;rw;drf;rw;drf
opt_clean -purge
</code>
        </div>

        <h3>21.5.2 Timing Optimization</h3>

        <div class="code-block">
<code><span class="comment"># Timing-focused: break paths, insert buffers</span>
synth -top gpu
abc -liberty lib.lib -D 10000   <span class="comment"># 10ns clock target</span>
opt -fast
</code>
        </div>

        <h3>21.5.3 Power Optimization</h3>

        <div class="code-block">
<code><span class="comment"># Power-focused: use smaller cells where timing permits</span>
synth -top gpu
abc -liberty lib.lib -G 100      <span class="comment"># Gate count limit</span>
opt -full
</code>
        </div>

        <h2>21.6 RTL to Gates Example</h2>

        <h3>21.6.1 Before Synthesis (RTL)</h3>

        <div class="code-block">
<code><span class="comment">// ALU add/subtract logic</span>
<span class="keyword">always_comb</span> <span class="keyword">begin</span>
    <span class="keyword">case</span> (op)
        <span class="number">2'b00</span>: result = a + b;
        <span class="number">2'b01</span>: result = a - b;
        <span class="keyword">default</span>: result = <span class="number">8'b0</span>;
    <span class="keyword">endcase</span>
<span class="keyword">end</span>
</code>
        </div>

        <h3>21.6.2 After Synthesis (Gates)</h3>

        <div class="mermaid">
graph TB
    A["a[7:0]"] --> ADDER["Ripple Carry<br/>Adder"]
    B["b[7:0]"] --> MUX_B["MUX<br/>b or ~b"]
    OP["op[0]"] --> MUX_B
    OP --> CARRY["Carry In<br/>for subtraction"]
    MUX_B --> ADDER
    CARRY --> ADDER
    ADDER --> MUX_OUT["Output MUX"]
    OP --> MUX_OUT
    MUX_OUT --> RESULT["result[7:0]"]
    
    style ADDER fill:#e3f2fd
    style MUX_B fill:#fff3e0
    style MUX_OUT fill:#fff3e0
        </div>

        <h2>21.7 Synthesis Constraints</h2>

        <div class="code-block">
<code><span class="comment"># SDC (Synopsys Design Constraints) format</span>

<span class="comment"># Define clock</span>
create_clock -name clk -period 10.0 [get_ports clk]

<span class="comment"># Input delay (relative to clock)</span>
set_input_delay -clock clk 2.0 [all_inputs]

<span class="comment"># Output delay</span>
set_output_delay -clock clk 2.0 [all_outputs]

<span class="comment"># False paths (timing not checked)</span>
set_false_path -from [get_ports reset]

<span class="comment"># Multicycle paths</span>
set_multicycle_path 2 -from [get_pins slow_reg/Q]
</code>
        </div>

        <h2>21.8 Exercises</h2>

        <div class="exercise">
            <h4>Exercise 21.1: Count Gates</h4>
            <p>Given the synthesis report above, how many flip-flops (DFF cells) does the GPU have? What does this represent in terms of design state?</p>
            
            <details>
                <summary><strong>Click to reveal solution</strong></summary>
                <div class="solution">
                    <p>The report shows 1024 dfxtp_1 cells (D flip-flops with positive edge trigger).</p>
                    <p>This represents 1024 bits of sequential state: registers, FSM states, pipeline registers, etc.</p>
                </div>
            </details>
        </div>

        <div class="exercise">
            <h4>Exercise 21.2: Optimize for Speed</h4>
            <p>Your design has a 15ns critical path but you need 10ns. What synthesis strategies could help?</p>
            
            <details>
                <summary><strong>Click to reveal solution</strong></summary>
                <div class="solution">
                    <ol>
                        <li>Use higher drive strength cells on critical path</li>
                        <li>Add pipeline registers to break long paths</li>
                        <li>Use abc with tighter timing target (-D 10000)</li>
                        <li>Restructure RTL to reduce logic depth</li>
                        <li>Use carry-select or carry-lookahead adders</li>
                    </ol>
                </div>
            </details>
        </div>

        <h2>21.9 Key Takeaways</h2>

        <div class="key-takeaway">
            <p><strong>üîß Synthesis = RTL ‚Üí Gates:</strong> Converts behavioral code to physical logic gates from a technology library.</p>
        </div>

        <div class="key-takeaway">
            <p><strong>üìö Libraries define the building blocks:</strong> Standard cells with known timing, area, and power characteristics.</p>
        </div>

        <div class="key-takeaway">
            <p><strong>‚öñÔ∏è Trade-offs are everywhere:</strong> Area vs. speed vs. power. Constraints guide the optimizer.</p>
        </div>

        <div class="key-takeaway">
            <p><strong>üõ†Ô∏è Yosys + ABC = Open-source synthesis:</strong> Viable for learning and even production (via OpenLane).</p>
        </div>

        <div class="nav-container">
            <a href="chapter-20.html">‚Üê Previous: Simulation and Debugging</a>
            <a href="../table-of-contents.html">Table of Contents</a>
            <a href="chapter-22.html">Next: Physical Design Flow ‚Üí</a>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <script src="../navigation.js"></script>
</body>
</html>
